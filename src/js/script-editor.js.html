<script>
    $(document).ready(async function () {
        $('#app').addClass('d-none');
        $('#loader').removeClass('d-none');
        $('#home-stock').click(async function () {
            $('#app').addClass('d-none');
            $('#loader').removeClass('d-none');
            await initializePage();
            await stockForm();
            await loadCurrentUser();
            await stockDetailsForm();
        });
        await stockForm();
        await stockDetailsForm();
        await initializePage();
        await stockTransactionsForm();
    });

    async function navigateHome() {
        await initializePage();
    }

    async function initializePage() {
        $('#stock-related').removeClass('d-none');
        $('#stock-details').addClass('d-none');
        google.script.run.withSuccessHandler(loadStockTable).withFailureHandler(onFailure).getStocks();
    }

    function loadStockTable(response) {
        $('#loader').addClass('d-none');
        $('#app').removeClass('d-none');
        let options = {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
        };

        let dataSet = [];
        let count = 0;
        if (response !== null) {
            response.forEach(stock => {
                count++;
                dataSet.push([count,
                    stock.material,
                    stock.stockBook,
                    stock.stockBookReference,
                    stock.createdBy,
                    new Date(stock.createdAt).toLocaleDateString('en-US', options),
                    `<button class="btn btn-primary" onclick="viewStock('${stock.id}','${stock.material}')"><i class="fa fa-eye"></i> View</button>`
                ]);
            })
        }
        $('#stocks_table').DataTable({
            data: dataSet,
            responsive: true,
            columns: [
                { title: '#' },
                { title: 'Description of Material' },
                { title: 'Book Folio' },
                { title: 'Reference' },
                { title: 'Created By' },
                { title: 'Created At' },
                { title: 'Action' }
            ],
            columnDefs: [
                {
                    targets: [0, 1, 2, 3, 4, 5, 6],
                    className: 'text-center'
                }
            ],
            order: [[1, 'asc']],
            destroy: true,
            lengthMenu: [[10, 25, 50, -1], ['10 rows', '25 rows', '50 rows', "Show all"]],
            autoWidth: false,
        });
    }

    async function viewStock(id, material) {
        $('#loader').removeClass('d-none');
        $('#app').addClass('d-none');
        $('#stock-related').addClass('d-none');
        $('#stock-details').removeClass('d-none');
        $('#material_name').text(material);
        $("#exampleModalLabel").text(material);
        // set hidden input stockId value to id
        $('#stockId').val(id);
        google.script.run.withSuccessHandler(loadStockDetailsTable).withFailureHandler(onFailure).getStockDetails(id);
    }

    function loadStockDetailsTable(response) {
        $('#loader').addClass('d-none');
        $('#app').removeClass('d-none');
        let options = {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
        };
        const currencyFormatter = new Intl.NumberFormat('en-US', {
            style: 'currency',
            currency: 'LKR',
        });
        let dataSet = [];
        let count = 0;
        if (response !== null) {
            response.forEach(stock => {
                count++;
                dataSet.push([count,
                    stock.minimumStock,
                    stock.stockBalance,
                    stock.units,
                    currencyFormatter.format(stock.unitPrice),
                    stock.store,
                    stock.remarks,
                    stock.createdBy,
                    new Date(stock.createdAt).toLocaleDateString('en-US', options),
                    `<button type="button" class="btn btn-warning btn-sm" data-bs-toggle="modal" onclick="viewStockDetails('${stock.id}')" data-bs-target="#exampleModalView"><i class="fa-solid fa-eye"></i> View</button>
                    <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" onclick="updateStockDetails('${stock.id}','${stock.stockId}')" data-bs-target="#exampleModal"><i class="fa-solid fa-rotate"></i> Update</button>`
                ]);
            })
        }
        $('#stock_details_table').DataTable({
            data: dataSet,
            responsive: true,
            columns: [
                { title: '#' },
                { title: 'Minimum Stock' },
                { title: 'Stock Balance' },
                { title: 'Units' },
                { title: 'Unit Price' },
                { title: 'Store' },
                { title: 'Remarks' },
                { title: 'Created By' },
                { title: 'Created At' },
                { title: 'Action' }
            ],
            columnDefs: [
                {
                    targets: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9],
                    className: 'text-center'
                }
            ],
            order: [[1, 'asc']],
            destroy: true,
            lengthMenu: [[10, 25, 50, -1], ['10 rows', '25 rows', '50 rows', "Show all"]],
            autoWidth: false,
            createdRow: function (row, data, dataIndex) {
                if (+data[1] >= +data[2]) {
                    $(row).addClass('red-text');
                }
            },
        });
    }

    function updateStockDetails(stockDetailsId, stockId) {
        const modal = document.getElementById('exampleModal');
        modal.querySelector('#stockDetailsId').value = stockDetailsId;
        modal.querySelector('#stockId').value = stockId;
        modal.querySelector('#issuedTo').value = '';
        modal.querySelector('#receivedFrom').value = '';
        modal.querySelector('#issuedQuantity').value = '';
        modal.querySelector('#receivedQuantity').value = '';
    }

    function viewStockDetails(stockDetailsId) {
        const modal = document.getElementById('exampleModalView');
        modal.querySelector('#app').classList.add('d-none');
        modal.querySelector('#loader').classList.remove('d-none');

        google.script.run.withSuccessHandler(loadStockDetails).withFailureHandler(onFailure).getStockTransactions(stockDetailsId);
    }

    function loadStockDetails(res) {
        const modal = document.getElementById('exampleModalView');
        modal.querySelector('#app').classList.remove('d-none');
        modal.querySelector('#loader').classList.add('d-none');
        modal.querySelector('#app').innerHTML = '';
        // data
        const data = res;
        // create a table
        let table = document.createElement('table');
        table.classList.add('table');
        table.classList.add('table-striped');
        table.classList.add('table-bordered');
        table.classList.add('table-sm');
        table.classList.add('table-hover');
        table.classList.add('table-responsive');
        table.classList.add('text-center');
        // create the table header
        let thead = document.createElement('thead');
        let tr = document.createElement('tr');
        let th = document.createElement('th');
        th.innerHTML = '#';
        tr.appendChild(th);
        th = document.createElement('th');
        th.innerHTML = 'Issued To';
        tr.appendChild(th);
        th = document.createElement('th');
        th.innerHTML = 'Received From';
        tr.appendChild(th);
        th = document.createElement('th');
        th.innerHTML = 'Issued Quantity';
        tr.appendChild(th);
        th = document.createElement('th');
        th.innerHTML = 'Received Quantity';
        tr.appendChild(th);
        th = document.createElement('th');
        th.innerHTML = 'Created By';
        tr.appendChild(th);
        th = document.createElement('th');
        th.innerHTML = 'Created At';
        tr.appendChild(th);
        thead.appendChild(tr);
        table.appendChild(thead);
        // create the table body
        let tbody = document.createElement('tbody');
        data.forEach(stock => {
            tr = document.createElement('tr');
            th = document.createElement('th');
            th.innerHTML = stock.id;
            tr.appendChild(th);
            th = document.createElement('th');
            th.innerHTML = stock.issuedTo;
            tr.appendChild(th);
            th = document.createElement('th');
            th.innerHTML = stock.receivedFrom;
            tr.appendChild(th);
            th = document.createElement('th');
            th.innerHTML = stock.issuedQuantity;
            tr.appendChild(th);
            th = document.createElement('th');
            th.innerHTML = stock.receivedQuantity;
            tr.appendChild(th);
            th = document.createElement('th');
            th.innerHTML = stock.createdBy;
            tr.appendChild(th);
            th = document.createElement('th');
            th.innerHTML = stock.createdAt;
            tr.appendChild(th);
            tbody.appendChild(tr);
        });
        table.appendChild(tbody);
        modal.querySelector('#app').appendChild(table);
    }

    function hideIssuedTo(x) {
        if (x.checked) {
            document.getElementById('stockIssued').style.display = 'none';
            document.getElementById('stockReceived').style.display = 'block';
        }
    }

    function hideReceived(x) {
        if (x.checked) {
            document.getElementById('stockIssued').style.display = 'block';
            document.getElementById('stockReceived').style.display = 'none';
        }
    }

    function stockTransactionsForm() {
        const modal = document.getElementById('exampleModal');
        modal.querySelector('#stockTransactionsForm').addEventListener('submit', (e) => {
            e.preventDefault();
            let stockId = $('#stockId').val();
            let stockDetailsId = $('#stockDetailsId').val();
            let issuedTo = $('#issuedTo').val();
            let receivedFrom = $('#receivedFrom').val();
            let receivedQuantity = $("#receivedQuantity").val();
            let issuedQuantity = $("#issuedQuantity").val();
            let materialName = $('#material_name').text()
            let stockTransactions = {
                stockId: stockId,
                stockDetailsId: stockDetailsId,
                issuedTo: issuedTo,
                receivedFrom: receivedFrom,
                issuedQuantity: issuedQuantity,
                receivedQuantity: receivedQuantity,
                materialName: materialName,
            };
            $('#loader').removeClass('d-none');
            $('#app').addClass('d-none');
            $('#exampleModal').modal('hide');
            google.script.run.withSuccessHandler(onSuccessStockTransactionForm).withFailureHandler(onFailure).saveStockTransaction(stockTransactions);
        });
    }

    async function onSuccessStockTransactionForm(res) {
        $('#loader').addClass('d-none');
        $('#app').removeClass('d-none');
        // close modal
        $('#exampleModal').modal('hide');
        await viewStock(res.stockId, res.materialName).then(() => {
            Swal.fire(
                'Saved!',
                'Your record has been saved.',
                'success'
            )
        });
    }

    async function loadCurrentUser() {
        google.script.run
            .withFailureHandler(onFailure)
            .withSuccessHandler(loadCurrentUserSuccess)
            .getCurrentUser();

    }

    function loadCurrentUserSuccess(user) {
        $('#currentUser').text(user);
    }

    async function stockForm() {
        $.validator.addMethod("regex", function (value, element, regexp) {
            return this.optional(element) || new RegExp(regexp).test(value);
        }, "Please enter a valid value.");
        $('#stockForm').validate({
            errorClass: 'is-invalid',
            validClass: 'is-valid',
            errorElement: "em",
            errorPlacement: function (error, element) {
                error.addClass('invalid-feedback');
                if (element.prop("type") === "checkbox") {
                    error.insertAfter(element.parent("label"));
                } else {
                    error.insertAfter(element);
                }
            },
            rules: {
                material: {
                    required: true,
                    minlength: 10
                },
                stockBook: {
                    required: true
                },
                stockBookReference: {
                    required: true
                },
            },
            messages: {
                material: {
                    required: "Please enter description of material",
                    minlength: "Description of material must be at least 10 characters long"
                },
                stockBook: {
                    required: "Please enter book folio"
                },
                stockBookReference: {
                    required: "Please enter folio reference"
                },
            },
            submitHandler: function (form) {
                if (event.target.id === 'stockForm') {
                    event.preventDefault();
                    $('#submitBtn').prop('disabled', true);
                    $('#loader').removeClass('d-none');
                    $('#app').addClass('d-none');
                    submitForm(form);
                }
                return false;
            }
        })
    }

    function submitForm(form) {
        const data = {};
        $.each($('#stockForm').serializeArray(), function (i, field) {
            if (field.name === 'unitPrice') {
                data[field.name] = parseFloat(field.value);
            } else {
                data[field.name] = field.value;
            }
        });
        google.script.run
            .withFailureHandler(onFailure)
            .withSuccessHandler(submitFormSuccessHandler)
            .saveStock(data);
    }

    async function submitFormSuccessHandler() {
        // reset the form and validation
        $('#stockForm').validate().resetForm();
        // remove classes
        $('#stockForm').find('.is-invalid').removeClass('is-invalid');
        $('#stockForm').find('.is-valid').removeClass('is-valid');
        // reset the form
        $('#stockForm').trigger('reset');

        $('#submitBtn').prop('disabled', false);
        $('#loader').addClass('d-none');
        $('#app').removeClass('d-none');
        await initializePage().then(() => {
            Swal.fire(
                'Saved!',
                'Your record has been saved.',
                'success'
            )
        });
    }

    async function stockDetailsForm() {
        $('#stockDetailsForm').validate({
            errorClass: 'is-invalid',
            validClass: 'is-valid',
            errorElement: "em",
            errorPlacement: function (error, element) {
                error.addClass('invalid-feedback');
                if (element.prop("type") === "checkbox") {
                    error.insertAfter(element.parent("label"));
                } else {
                    error.insertAfter(element);
                }
            },
            rules: {
                minimumStock: {
                    required: true
                },
                units: {
                    required: true
                },
                unitPrice: {
                    required: true,
                    number: true,
                    regex: /^[0-9.]+$/
                },
                store: {
                    required: true
                },
                remark: {
                    required: true
                },
            },
            messages: {
                minimumStock: {
                    required: 'Please enter minimum stock value'
                },
                units: {
                    required: 'Please enter the measuring unit'
                },
                unitPrice: {
                    required: "Please enter unit price",
                    number: "Please enter a valid number",
                    regex: "Please enter a valid number with out comma and space"
                },
                store: {
                    required: 'Please select the store'
                },
                remark: {
                    required: 'Please type the remarks'
                }
            },
            submitHandler: function (form) {
                if (event.target.id === 'stockDetailsForm') {
                    event.preventDefault();
                    $('#submitBtn').prop('disabled', true);
                    $('#loader').removeClass('d-none');
                    $('#app').addClass('d-none');
                    submitStoreDetailsForm(form);
                }
                return false;
            }
        })
    }

    function submitStoreDetailsForm(form) {
        const data = {};
        $.each($('#stockDetailsForm').serializeArray(), function (i, field) {
            if (field.name === 'unitPrice') {
                data[field.name] = parseFloat(field.value);
            } else if (field.name === 'minimumStock') {
                data[field.name] = parseInt(field.value);

            } else {
                data[field.name] = field.value;
            }
        });
        google.script.run
            .withFailureHandler(onFailure)
            .withSuccessHandler(submitStoreDetailsFormSuccessHandler)
            .saveStockDetails(data);
    }

    async function submitStoreDetailsFormSuccessHandler(res) {
        // reset the form and validation
        $('#stockDetailsForm').validate().resetForm();
        // remove classes
        $('#stockDetailsForm').find('.is-invalid').removeClass('is-invalid');
        $('#stockDetailsForm').find('.is-valid').removeClass('is-valid');
        // reset the form
        $('#stockDetailsForm').trigger('reset');

        $('#submitBtn').prop('disabled', false);
        $('#loader').addClass('d-none');
        $('#app').removeClass('d-none');

        await viewStock(res.stockId, res.material).then(() => {
            Swal.fire(
                'Saved!',
                'Your record has been saved.',
                'success'
            )
        });
    }

    function onFailure(err) {
        console.log(err);
        $('#loader').addClass('d-none');
        $('#app').removeClass('d-none');
        Swal.fire({
            icon: 'error',
            title: 'Oops...',
            text: 'Something went wrong!',
        });
    }
</script>